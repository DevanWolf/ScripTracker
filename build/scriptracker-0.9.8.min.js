"use strict";function ItLoader(){}function Module(){this.name="",this.type=null,this.songLength=0,this.restartPosition=0,this.orders=[],this.channels=0,this.patternCount=0,this.patterns=[],this.instrumentCount=0,this.instruments=[],this.signedSample=!0,this.defaultTempo=6,this.defaultBPM=125,this.defaultVolume=1}function Pattern(e,t){this.patternIndex=0,this.rows=e,this.columns=t,this.note=[],this.instrument=[],this.volume=[],this.effect=[],this.effectParam=[];for(var a=0;e>a;a++){this.note[a]=[],this.instrument[a]=[],this.volume[a]=[],this.effect[a]=[],this.effectParam[a]=[];for(var n=0;t>n;n++)this.note[a][n]=0,this.instrument[a][n]=0,this.volume[a][n]=-1,this.effect[a][n]=Effects.NONE,this.effectParam[a][n]=0}var o=["C-","C#","D-","D#","E-","F-","F#","G-","G#","A-","A#","B-"],s="0123456789ABCDEF",r="DCBAUHPLRG";this.toText=function(e,t){var a="";if(0>e||e>=this.rows||0>t||t>=this.columns)return"... .. .. ...";if(0==this.note[e][t]?a+="...":97==this.note[e][t]?a+="===":(a+=o[(this.note[e][t]-1)%12],a+=Math.floor((this.note[e][t]-1)/12)),a+=" ",0!=this.instrument[e][t]?(a+=s.charAt(Math.floor(this.instrument[e][t]/16)),a+=s.charAt(this.instrument[e][t]%16)):a+="..",a+=" ",this.volume[e][t]>-1){var n=this.volume[e][t];a+=n>=80?r.charAt(Math.floor((n-80)/16)):s.charAt(Math.floor(n/16)),a+=s.charAt(n%16)}else a+="..";return a+=" ",this.effect[e][t]!=Effects.NONE?(a+=this.effect[e][t].representation,11==a.length&&(a+=s.charAt(Math.floor(this.effectParam[e][t]/16))),a+=s.charAt(this.effectParam[e][t]%16)):a+="...",a}}function S3mLoader(e){var t=new Module;t.type=ModTypes.S3M,t.channels=32,t.name=e.substring(0,28),t.songLength=e.charCodeAt(32)+256*e.charCodeAt(33),t.sampleCount=e.charCodeAt(34)+256*e.charCodeAt(35),t.patternCount=e.charCodeAt(36)+256*e.charCodeAt(37),t.signedSample=1===e.charCodeAt(42)?!0:!1,t.volumeSlideFlag=0!==(64&e.charCodeAt(38))||0===e.charCodeAt(40),t.defaultVolume=e.charCodeAt(48)/64,t.defaultTempo=0===e.charCodeAt(49)?6:e.charCodeAt(49),t.defaultBPM=e.charCodeAt(50)<33?125:e.charCodeAt(50),t.defaultVolume=e.charCodeAt(51)/64;for(var a=0;a<t.songLength;a++)t.orders[a]=e.charCodeAt(96+a);for(var n=96+t.songLength,o=96+t.songLength+2*t.sampleCount,a=0;a<t.sampleCount;a++){var s=new Instrument,r=16*(e.charCodeAt(n+2*a)+256*e.charCodeAt(n+2*a+1)),l=e.substring(r,r+80),i=new Sample;i.sampleIndex=a,i.name=l.substring(48,76),i.sampleLength=l.charCodeAt(16)+256*l.charCodeAt(17),i.loopStart=l.charCodeAt(20)+256*l.charCodeAt(21),i.loopLength=l.charCodeAt(24)+256*l.charCodeAt(25)-i.loopStart,i.volume=l.charCodeAt(28)/64,i.loopType=0!==(1&l.charCodeAt(31))?SampleLoop.LOOP_FORWARD:SampleLoop.LOOP_NONE,i.basePeriod=l.charCodeAt(32)+256*l.charCodeAt(33),i.basePeriod=i.basePeriod/8363,i.basePeriod=Math.log(i.basePeriod)/Math.log(2)*768+3168,i.basePeriod=-(Math.floor(i.basePeriod/64)-72);var p=16*l.charCodeAt(14)+4096*l.charCodeAt(15),f=0!==(4&l.charCodeAt(31)),c=i.sampleLength*(f?2:1);0===(2&l.charCodeAt(31))?i.loadSample(e.substring(p,p+c),f,t.signedSample):i.loadStereoSample(e.substring(p,p+c),f,t.signedSample),s.name=i.name,s.samples.push(i),t.instruments.push(s)}for(var h=0;h<t.patternCount;h++){for(var m=16*(e.charCodeAt(o+2*h)+256*e.charCodeAt(o+2*h+1)),u=e.charCodeAt(m)+256*e.charCodeAt(m+1),d=e.substring(m,m+u),E=new Pattern(64,t.channels),T=2,a=0;64!==a&&d.length-T>0;){var v=d.charCodeAt(T);if(0!==v){var O=31&v;if(0!==(32&v)){if(T++,254===d.charCodeAt(T))E.note[a][O]=97;else if(255===d.charCodeAt(T))E.note[a][O]=0;else{var A=12*Math.floor(d.charCodeAt(T)/16);E.note[a][O]=d.charCodeAt(T)%16+A+1}E.instrument[a][O]=d.charCodeAt(++T)}if(E.volume[a][O]=0!==(64&v)?d.charCodeAt(++T):-1,0!==(128&v)){var S=d.charCodeAt(++T),P=d.charCodeAt(++T);switch(E.effectParam[a][O]=P,S){case 1:E.effect[a][O]=Effects.SET_SPEED;break;case 2:E.effect[a][O]=Effects.POSITION_JUMP;break;case 3:E.effect[a][O]=Effects.PATTERN_BREAK;break;case 4:E.effect[a][O]=Effects.VOLUME_SLIDE;break;case 5:E.effect[a][O]=Effects.PORTA_DOWN,P>=240?E.effectParam[a][O]=Math.round(P%16/16):P>=224&&(E.effectParam[a][O]=Math.round(P%16/4));break;case 6:E.effect[a][O]=Effects.PORTA_UP,P>=240?E.effectParam[a][O]=Math.round(P%16/16):P>=224&&(E.effectParam[a][O]=Math.round(P%16/4));break;case 7:E.effect[a][O]=Effects.TONE_PORTA;break;case 8:E.effect[a][O]=Effects.VIBRATO;break;case 9:E.effect[a][O]=Effects.TREMOR;break;case 10:E.effect[a][O]=Effects.ARPEGGIO;break;case 11:E.effect[a][O]=Effects.VIBRATO_VOL_SLIDE;break;case 12:E.effect[a][O]=Effects.TONE_PORTA_VOL_SLIDE;break;case 15:E.effect[a][O]=Effects.SAMPLE_OFFSET;break;case 17:E.effect[a][O]=Effects.RETRIG_VOL_SLIDE;break;case 18:E.effect[a][O]=Effects.TREMOLO;break;case 19:var g=(240&P)>>4;switch(g){case 0:E.effect[a][O]=Effects.SET_FILTER;break;case 1:E.effect[a][O]=Effects.SET_GLISANDO;break;case 2:E.effect[a][O]=Effects.SET_FINETUNE;break;case 3:E.effect[a][O]=Effects.SET_VIBRATO;break;case 4:E.effect[a][O]=Effects.SET_TREMOLO;break;case 8:case 10:E.effect[a][O]=Effects.SET_PAN_16;break;case 11:E.effect[a][O]=Effects.SET_LOOP;break;case 12:E.effect[a][O]=Effects.CUT_NOTE;break;case 13:E.effect[a][O]=Effects.DELAY_NOTE;break;case 14:E.effect[a][O]=Effects.DELAY_PATTERN;break;default:console.log("Unknown effect: "+S+", "+P),E.effect[a][O]=Effects.NONE}break;case 20:E.effect[a][O]=Effects.SET_TEMPO;break;case 21:break;case 22:E.effect[a][O]=Effects.SET_GLOBAL_VOLUME;break;default:console.log("Unknown effect: "+S+", "+P),E.effect[a][O]=Effects.NONE}}}else a++;T++}t.patterns.push(E)}return t}function Sample(){this.sampleIndex=0,this.name="",this.sampleLength=0,this.loopStart=0,this.loopLength=0,this.loopType=SampleLoop.LOOP_NONE,this.dataType=SampleFormat.FORMAT_8BIT|SampleFormat.TYPE_UNCOMPRESSED,this.volume=1,this.panning=.5,this.basePeriod=0,this.fineTune=0,this.sample=[],this.loadSample=function(e,t,a){this.sample=[];for(var n=0,o=0;o<this.sampleLength;o++){if(t){var s=e.charCodeAt(2*o)+256*e.charCodeAt(2*o+1);n=a?32768>s?s/32767:-((65535^s)+1)/32768:s/32768-1}else{var r=e.charCodeAt(o);n=a?128>r?r/127:-((255^r)+1)/128:r/128-1}this.sample.push(n)}},this.loadStereoSample=function(e,t,a){this.loadSample(sampledata.substring(0,this.sampleLength*t?2:1),t,a);var n=this.sample;this.loadSample(sampledata.substring(this.sampleLength*t?2:1),t,a);var o=this.sample;this.sample=[];for(var s=0;s<this.sampleLength;s++)this.sample.push((n[s]+o[s])/2)},this.loadDeltaSample=function(e,t){for(var a=0,n=0;n<this.sampleLength;n++){if(t){var o=e.charCodeAt(n++)+(e.charCodeAt(n)<<8);o>32767&&(o=-(65536-o)),a+=o/32768}else{var s=e.charCodeAt(n);s>127&&(s=-(256-s)),a+=s/128}-1>a&&(a=1+(a+1)),a>1&&(a=-1+(a-1)),this.sample.push(a)}},this.loadAdpcmSample=function(e,t){console.log("adpcm sample");var a=[];this.sample=[];for(var n=0;16>n;n++)if(t){var o=e.charCodeAt(n++)+256*e.charCodeAt(n);a[n]=32768>o?o/32767:-((65535^o)+1)/32768}else{var s=e.charCodeAt(n);a[n]=128>s?s/127:-((255^s)+1)/128}for(var r=0,n=0;n<Math.floor(this.sampleLength/2);n++)r+=a[15&e.charCodeAt(n+t?32:16)],this.sample.push(r),r+=a[e.charCodeAt(n+t?32:16)>>4],this.sample.push(r)}}function ScripTracker(){function e(e){if(O)for(var s=e.outputBuffer,r=s.getChannelData(0),l=s.getChannelData(1),p=0;p<s.length;p++){for(var f=0,c=0,h=0;h<o.channels;h++){var m=C[h];if(m.sample.sample){var u=m.sample.sample.sample[Math.floor(m.sample.position)],v=m.volume.envelope.getValue(m.envelopePos,m.noteReleased,1),S=m.panning.envelope.getValue(m.envelopePos,m.noteReleased,.5),P=v*m.tremolo.volume*m.volume.channelVolume,g=Math.max(0,Math.min(m.panning.pan+(S-.5)*((2-Math.abs(m.panning.pan-2))/.5),1));m.envelopePos+=1/E,m.isMuted||m.tremor.muted||(m.panning.pan<=1?(f+=u*(1-g)*P,c+=u*g*P):(f+=.5*u*P,c-=.5*u*P)),m.sample.position+=m.sample.reversed?-m.sample.step:m.sample.step,m.sample.remain-=Math.abs(m.sample.step),m.sample.remain<=0&&(m.sample.sample.loopType===SampleLoop.LOOP_FORWARD?(m.sample.position=m.sample.sample.loopStart-m.sample.remain,m.sample.remain=m.sample.sample.loopLength+m.sample.remain):m.sample.sample.loopType===SampleLoop.LOOP_PINGPONG?(m.sample.position=Math.max(m.sample.sample.loopStart,m.sample.position),m.sample.position=Math.min(m.sample.sample.loopStart+m.sample.sample.loopLength-1,m.sample.position),m.sample.remain=m.sample.sample.loopLength,m.sample.reversed=!m.sample.reversed):(m.sample.position=m.sample.sample.sampleLength-1,m.sample.step=0))}}r[p]=f*A,l[p]=c*A,T++,T===E&&(T=0,i++,i===d&&a(),t(),0===i&&null!=N&&N(n))}}function t(){for(var e=0;e<o.channels;e++){var t=C[e],a=s.note[l][e],r=s.instrument[l][e],p=s.volume[l][e],f=s.effect[l][e],c=s.effectParam[l][e];if(0===i){if(0!==r){var h=o.instruments[r-1];if(h){var m=h.sampleKeyMap[a];h.samples[m]&&(t.sample.sample=h.samples[m],t.sample.remain=t.sample.sample.sampleLength,t.volume.sampleVolume=t.sample.sample.volume),t.sample.position=0,t.sample.reversed=!1,t.volume.envelope=h.volumeEnvelope,t.panning.envelope=h.panningEnvelope,t.envelopePos=0,t.noteReleased=!1,"mod"!==o.type&&t.sample.sample&&(t.panning.pan=t.sample.sample.panning),t.sample.sample&&t.sample.sample.sampleLength<1&&(t.sample.sample=null)}else t.sample.sample=null}if(0!==a&&f!==Effects.TONE_PORTA&&f!==Effects.TONE_PORTA_VOL_SLIDE)if(97===a)t.note=a,t.noteReleased=!0;else if(t.note=a-1,null!==t.sample.sample){t.period=7680-64*(a-26-t.sample.sample.basePeriod)-t.sample.sample.fineTune/2;var u=8363*Math.pow(2,(4608-t.period)/768);t.sample.position=0,t.volume.sampleVolume=t.sample.sample.volume,t.sample.remain=t.sample.sample.sampleLength,t.sample.step=u/v,t.sample.reversed=!1,t.noteDelay=0}t.tremolo.volume=1,t.tremor.muted=!1,p>=0&&64>=p?t.volume.channelVolume=p/64:97>a&&0!==r&&(t.volume.channelVolume=t.volume.sampleVolume)}p>64&&Effects.VOLUME_EFFECT.handler(t,p,i,e,n),f.handler(t,c,i,e,n)}}function a(){if(-1===g||M||(l=-1,r=Math.min(o.songLength-1,g),s=o.patterns[o.orders[r]]),-1!==P&&(l=P-1,!M&&-1===g)){for(r++;254===o.orders[r]&&r<o.songLength;)r++;(r===o.songLength||255==o.orders[r])&&(r=o.restartPosition),s=o.patterns[o.orders[r]]}if(-1!==_&&(l=_-1,_=-1),2>L?(g=-1,P=-1,i=0,L=0,l++):L--,!s)return n.stop(),n.rewind(),void n.resetPlayback();if(l===s.rows){for(l=0,M||r++;254===o.orders[r]&&r<o.songLength;)r++;(r>=o.songLength||255===o.orders[r])&&(r=o.restartPosition,n.resetPlayback()),s=o.patterns[o.orders[r]]}}for(var n=this,o=null,s=null,r=0,l=0,i=0,p=null,f=null,c=null,h=0,m=4096,u=0,d=0,E=0,T=0,v=0,O=!1,A=1,S=0,P=-1,g=-1,_=-1,L=0,M=!1,C=[],R=0;32>R;R++)C[R]=new ChannelRegisters;var N=null,b=null;if("undefined"!=typeof AudioContext)p=new AudioContext;else{if("undefined"==typeof webkitAudioContext)return void alert("No audio context!");p=new webkitAudioContext}h=p.sampleRate,v=3*Math.round(.02*h),f=p.createBufferSource(),c=p.createScriptProcessor(m,1,2),c.onaudioprocess=e,f.start(0),this.loadModule=function(e){if(o=e,"mod"==o.type)for(var t=0;t<o.channels;t++)C[t].panning.pan=t%2==0?.7:.3;this.resetPlayback(),b&&b()},this.load=function(e){var t=e.split(".").pop().toLowerCase(),a=new XMLHttpRequest;a.onload=function(){var e=a.response;if(e)switch(e=String.fromCharCode.apply(null,new Uint8Array(e)),t){case"mod":this.loadModule(ModLoader(e));break;case"s3m":this.loadModule(S3mLoader(e));break;case"xm":this.loadModule(XmLoader(e));break;default:return}}.bind(this),a.open("get",e,!0),a.responseType="arraybuffer",a.send()},this.resetPlayback=function(){for(var e=0;32>e;e++)C[e].reset();A=.9,S=0,P=-1,g=-1,_=-1,L=0,r=0,l=0,i=0,T=0,s=o.patterns[o.orders[r]],Effects.SET_TEMPO.handler(C[0],o.defaultBPM,0,0,this),Effects.SET_SPEED.handler(C[0],o.defaultTempo,0,0,this),t(),null!=N&&N(this)},this.play=function(){O||null==o||(t(),f.connect(c),c.connect(p.destination),O=!0)},this.debug=function(){f.stop()},this.stop=function(){c.disconnect(p.destination),f.disconnect(c),O=!1},this.prevOrder=function(){8>l&&r-1>=0&&254!=o.orders[r]&&(r--,s=o.patterns[o.orders[r]]),l=0,i=0,T=0;for(var e=0;e<o.channels;e++)C[e].reset();t()},this.nextOrder=function(){r<o.orders.length-1&&(r++,s=o.patterns[o.orders[r]]),l=0,i=0,T=0;for(var e=0;e<o.channels;e++)C[e].reset();t()},this.rewind=function(){r=0,l=0,i=0,null!=o&&(s=o.patterns[o.orders[r]],null!=N&&N(n))},this.isMuted=function(e){return C[e].isMuted},this.isPatternLoop=function(){return M},this.isPlaying=function(){return O},this.setMute=function(e,t){C[e].isMuted=t},this.setPatternLoop=function(e){M=e},this.setRowCallbackhandler=function(e){N=e},this.setOnSongLoaded=function(e){b=e},this.getSongName=function(){return o.name},this.getCurrentOrder=function(){return r+1},this.getCurrentPattern=function(){return o.orders[r]},this.getSongLength=function(){return o.songLength},this.getCurrentBPM=function(){return u},this.getCurrentTicks=function(){return d},this.getCurrentRow=function(){return l},this.getPatternRows=function(){return s.rows},this.getChannelVolume=function(e){return C[e].volume.sampleVolume*C[e].volume.channelVolume*A},this.getChannelInstrument=function(e){var t=C[e];return t.sample.sample&&t.sample.step>0?t.sample.sample.name:""},this.getNoteInfo=function(e,t){return s.toText(t,e,o.type)},this.dump=function(){console.log(registers),console.log(s)},this.getSamplesPerTick=function(){return E},this.setSamplesPerTick=function(e){E=e},this.getBpm=function(){return u},this.setBpm=function(e){u=e},this.getTicksPerRow=function(){return d},this.setTicksPerRow=function(e){d=e},this.getSampleRate=function(){return h},this.getSampleStepping=function(){return v},this.getNote=function(e){return s.note[l][e]},this.getPatternVolume=function(e){return s.volume[l][e]},this.setBreakPattern=function(e){P=e},this.getMasterVolume=function(){return A},this.setMasterVolume=function(e){A=e},this.getMasterVolSlide=function(){return S},this.setMasterVolSlide=function(e){S=e},this.getCurrentRow=function(){return l},this.setRowJump=function(e){_=e},this.setOrderJump=function(e){g=e}}function XmLoader(e){var t=new Module;t.type=ModTypes.XM;var a=readDWord(e,60),n=0;t.name=e.substring(17,37),t.songLength=readWord(e,64),t.restartPosition=readWord(e,66),t.channels=Math.min(readWord(e,68),32),t.patternCount=readWord(e,70),t.instrumentCount=readWord(e,72),t.defaultTempo=readWord(e,76),t.defaultBPM=readWord(e,78);for(var o=0;o<t.songLength;o++)t.orders.push(e.charCodeAt(80+o));n+=a+60;for(var s=0;s<t.patternCount;s++){var r=readDWord(e,n),l=readWord(e,n+5),i=readWord(e,n+7),p=new Pattern(l,t.channels);if(p.patternIndex=s,0!=i)for(var f=n+r,c=0;l>c;c++)for(var h=0;h<t.channels;h++){var m=e.charCodeAt(f++);if(0==(128&m)){p.note[c][h]=m,p.instrument[c][h]=e.charCodeAt(f++);var u=Math.max(-1,e.charCodeAt(f++)-16);p.volume[c][h]=u,p.effect[c][h]=e.charCodeAt(f++),p.effectParam[c][h]=e.charCodeAt(f++)}else{if(0!=(1&m)&&(p.note[c][h]=e.charCodeAt(f++)),0!=(2&m)&&(p.instrument[c][h]=e.charCodeAt(f++)),0!=(4&m)){var u=Math.max(-1,e.charCodeAt(f++)-16);p.volume[c][h]=u}else p.volume[c][h]=-1;0!=(8&m)&&(p.effect[c][h]=e.charCodeAt(f++)),0!=(16&m)&&(p.effectParam[c][h]=e.charCodeAt(f++)),0==(8&m)&&0!=(16&m)&&(p.effect[c][h]=0)}p.effect[c][h]!=Effects.NONE&&(p.effect[c][h]=parseEffect(p.effect[c][h],p.effectParam[c][h]))}t.patterns.push(p),n+=r+i}for(var o=0;o<t.instrumentCount;o++){var d=new Instrument,E=readDWord(e,n);if(d.name=e.substring(n+4,n+26),d.type=e.charCodeAt(n+26),d.numSamples=readWord(e,n+27),0==d.numSamples)n+=E;else{for(var T=0;96>T;T++)d.sampleKeyMap[T]=e.charCodeAt(n+33+T);var v=new Envelope;v.type=e.charCodeAt(n+233);var O=e.charCodeAt(n+225),A=e.charCodeAt(n+227),S=e.charCodeAt(n+228),P=e.charCodeAt(n+229),g=new Envelope;g.type=e.charCodeAt(n+234);for(var _=e.charCodeAt(n+226),L=e.charCodeAt(n+230),M=e.charCodeAt(n+231),C=e.charCodeAt(n+232),R=0;12>R;R++)O>R&&v.addPoint(readWord(e,n+129+4*R),Math.min(readWord(e,n+131+4*R)/64,1),R==A,R==S,R==P),_>R&&g.addPoint(readWord(e,n+177+4*R),Math.min(readWord(e,n+179+4*R)/64,1),R==L,R==M,R==C);d.volumeEnvelope=v,d.panningEnvelope=g,n+=E;for(var N=0;N<d.numSamples;N++){var b=new Sample;b.sampleLength=readDWord(e,n),b.loopStart=readDWord(e,n+4),b.loopLength=readDWord(e,n+8),b.volume=e.charCodeAt(n+12)/64,b.fineTune=e.charCodeAt(n+13)<128?e.charCodeAt(n+13):-((255^e.charCodeAt(n+13))+1),b.loopType=b.loopLength>0?3&e.charCodeAt(n+14):SampleLoop.LOOP_NONE,b.dataType=0==(16&e.charCodeAt(n+14))?SampleFormat.FORMAT_8BIT:SampleFormat.FORMAT_16BIT,b.panning=e.charCodeAt(n+15)/255,b.basePeriod=e.charCodeAt(n+16),b.dataType|=173==e.charCodeAt(n+17)?SampleFormat.TYPE_ADPCM:SampleFormat.TYPE_DELTA,b.name=d.name,b.basePeriod>127&&(b.basePeriod=-(256-b.basePeriod)),b.basePeriod=-b.basePeriod+24,d.samples.push(b),n+=40}for(var N=0;N<d.numSamples;N++){var b=d.samples[N];if(b.sampleLength>0){var V=e.substring(n,n+b.sampleLength),I=0!=(b.dataType&SampleFormat.FORMAT_16BIT);0==(b.dataType&SampleFormat.TYPE_DELTA)?b.loadDeltaSample(V,I):b.loadAdpcmSample(V,I),n+=b.sampleLength,0!=(b.dataType&SampleFormat.FORMAT_16BIT)&&(b.sampleLength/=2,b.loopStart/=2,b.loopLength/=2)}}}t.instruments.push(d)}return t}function parseEffect(e,t){switch(e){case 0:return Effects.ARPEGGIO;case 1:return Effects.PORTA_UP;case 2:return Effects.PORTA_DOWN;case 3:return Effects.TONE_PORTA;case 4:return Effects.VIBRATO;case 5:return Effects.TONE_PORTA_VOL_SLIDE;case 6:return Effects.VIBRATO_VOL_SLIDE;case 7:return Effects.TREMOLO;case 8:return Effects.SET_PAN;case 9:return Effects.SAMPLE_OFFSET;case 10:return Effects.VOLUME_SLIDE;case 11:return Effects.POSITION_JUMP;case 12:return Effects.SET_VOLUME;case 13:return Effects.PATTERN_BREAK;case 14:var a=(240&t)>>4;switch(a){case 1:return Effects.FINE_PORTA_UP;case 2:return Effects.FINE_PORTA_DOWN;case 3:return Effects.SET_GLISANDO;case 4:return Effects.SET_VIBRATO;case 5:return Effects.SET_FINETUNE;case 6:return Effects.SET_LOOP;case 7:return Effects.SET_TREMOLO;case 9:return Effects.RETRIGGER;case 10:return Effects.FINE_VOL_SLIDE_UP;case 11:return Effects.FINE_VOL_SLIDE_DOWN;case 12:return Effects.CUT_NOTE;case 13:return Effects.DELAY_NOTE;case 14:return Effects.DELAY_PATTERN;default:return Effects.NONE}case 15:return Effects.SET_TEMPO_BPM;case 16:return Effects.SET_GLOBAL_VOLUME;case 17:return Effects.GLOBAL_VOLUME_SLIDE;case 21:return Effects.ENVELOPE_POSITION;case 25:return Effects.PAN_SLIDE;case 27:return Effects.RETRIG_VOL_SLIDE;case 29:return Effects.TREMOR;case 33:var a=(240&t)>>4;switch(a){case 1:return Effects.EXTRA_FINE_PORTA_UP;case 2:return Effects.EXTRA_FINE_PORTA_DOWN;default:return Effects.NONE}default:return Effects.NONE}}function readWord(e,t){return e.charCodeAt(t)+(e.charCodeAt(t+1)<<8)}function readDWord(e,t){return e.charCodeAt(t)+(e.charCodeAt(t+1)<<8)+(e.charCodeAt(t+2)<<16)+(e.charCodeAt(t+3)<<24)}var Effects={NONE:{representation:".",handler:function(){}},ARPEGGIO:{representation:"0",handler:function(e,t,a,n,o){var s;a%3===0?s=0:a%3===1?s=64*((240&t)>>4):a%3===2&&(s=64*(15&t));var r=8363*Math.pow(2,(4608-e.period+s)/768);e.sample.step=r/o.getSampleStepping()}},PORTA_UP:{representation:"1",handler:function(e,t,a,n,o){if(0===a&&0!==t)e.porta.step=t;else if(a>0){e.period-=e.porta.step*o.getTicksPerRow();var s=8363*Math.pow(2,(4608-e.period)/768);e.sample.step=s/o.getSampleStepping()}}},PORTA_DOWN:{representation:"2",handler:function(e,t,a,n,o){if(0===a&&0!==t)e.porta.step=t;else if(a>0){e.period+=e.porta.step*o.getTicksPerRow();var s=8363*Math.pow(2,(4608-e.period)/768);e.sample.step=s/o.getSampleStepping()}}},TONE_PORTA:{representation:"3",handler:function(e,t,a,n,o){if(e.sample.sample){0===a&&0!==t&&(e.porta.step=t),0===a&&0!==o.getNote(n)&&(e.porta.notePeriod=7680-64*(o.getNote(n)-26-e.sample.sample.basePeriod)-e.sample.sample.fineTune/2),e.period<e.porta.notePeriod?(e.period+=e.porta.step*o.getTicksPerRow(),e.period>e.porta.notePeriod&&(e.period=e.porta.notePeriod)):e.period>e.porta.notePeriod&&(e.period-=e.porta.step*o.getTicksPerRow(),e.period<e.porta.notePeriod&&(e.period=e.porta.notePeriod));var s=8363*Math.pow(2,(4608-e.period)/768);e.sample.step=s/o.getSampleStepping()}}},VIBRATO:{representation:"4",handler:function(e,t,a,n,o){0===a&&0!==t&&(0!==(240&t)&&(e.vibrato.step=2*Math.PI*((240&t)>>4)*o.getTicksPerRow()/64),0!==(15&t)&&(e.vibrato.amplitude=2*(15&t)),e.vibrato.position=0);var s=Math.sin(e.vibrato.position)*e.vibrato.amplitude,r=8363*Math.pow(2,(4608-e.period+s)/768);e.sample.step=r/o.getSampleStepping(),e.vibrato.position+=e.vibrato.step}},TONE_PORTA_VOL_SLIDE:{representation:"5",handler:function(e,t,a,n,o){if(e.sample.sample){0===a&&0!=o.getNote(n)&&(e.porta.notePeriod=7680-64*(o.getNote(n)-26-e.sample.sample.basePeriod)-e.sample.sample.fineTune/2),e.period<e.porta.notePeriod?(e.period+=e.porta.step,e.period>e.porta.notePeriod&&(e.period=e.porta.notePeriod)):e.period>e.porta.notePeriod&&(e.period-=e.porta.step,e.period<e.porta.notePeriod&&(e.period=e.porta.notePeriod));var s=8363*Math.pow(2,(4608-e.period)/768);e.sample.step=s/o.getSampleStepping();var r=(0!=(240&t)?(240&t)>>4:-(15&t))/64;e.volume.channelVolume=Math.max(0,Math.min(e.volume.channelVolume+r,1))}}},VIBRATO_VOL_SLIDE:{representation:"6",handler:function(e,t,a,n,o){0===a&&0!==t&&(e.volume.channelVolumeSlide=t);var s=Math.sin(e.vibrato.position)*e.vibrato.amplitude,r=8363*Math.pow(2,(4608-e.period+s)/768);e.sample.step=r/o.getSampleStepping(),e.vibrato.position+=e.vibrato.step;var l=(0!=(240&e.volume.channelVolumeSlide)?(240&e.volume.channelVolumeSlide)>>4:-(15&e.volume.channelVolumeSlide))/64;e.volume.channelVolume=Math.max(0,Math.min(e.volume.channelVolume+l,1))}},TREMOLO:{representation:"7",handler:function(e,t,a,n,o){0===a&&0!==t&&(0!==(240&t)&&(e.tremolo.step=2*Math.PI*((240&t)>>4)*o.getTicksPerRow()/64),0!==(15&t)&&(e.tremolo.amplitude=(15&t)/30),e.tremolo.position=0),e.tremolo.volume=1-Math.sin(e.tremolo.position)*e.tremolo.amplitude,e.tremolo.position+=e.tremolo.step}},SET_PAN:{representation:"8",handler:function(e,t,a){0===a&&(e.panning.pan=1-t/128)}},SAMPLE_OFFSET:{representation:"9",handler:function(e,t,a){0===a&&(e.sample.position=256*t,e.sample.remain-=256*t)}},VOLUME_SLIDE:{representation:"A",handler:function(e,t,a){if(0===a&&0!==t&&(e.volume.channelVolumeSlide=t),a>0&&0!==e.volume.channelVolumeSlide)if(240===(240&e.volume.channelVolumeSlide)&&0!==(15&e.volume.channelVolumeSlide)){if(1===a){var n=(15&e.volume.channelVolumeSlide)/64;e.volume.channelVolume=Math.max(0,e.volume.channelVolume-n)}}else if(15===(15&e.volume.channelVolumeSlide)&&0!==(240&e.volume.channelVolumeSlide)){if(1===a){var n=((240&e.volume.channelVolumeSlide)>>4)/64;e.volume.channelVolume=Math.min(1,e.volume.channelVolume+n)}}else{var n=(0!=(240&e.volume.channelVolumeSlide)?(240&e.volume.channelVolumeSlide)>>4:-(15&e.volume.channelVolumeSlide))/64;e.volume.channelVolume=Math.max(0,Math.min(e.volume.channelVolume+n,1))}}},POSITION_JUMP:{representation:"B",handler:function(e,t,a,n,o){0===a&&o.setOrderJump(t)}},SET_VOLUME:{representation:"C",handler:function(e,t,a){0===a&&(e.volume.channelVolume=Math.max(0,Math.min(t/64,1)))}},PATTERN_BREAK:{representation:"D",handler:function(e,t,a,n,o){0===a&&o.setBreakPattern(10*((240&t)>>4)+(15&t))}},SET_FILTER:{representation:"E",handler:function(e,t,a){0===a&&console.log("Effect not supported: SET_FILTER")}},FINE_PORTA_UP:{representation:"E",handler:function(e,t,a,n,o){if(0===a){t&!0&&(e.porta.step=15&t),e.period-=e.porta.step*o.getTicksPerRow();var s=8363*Math.pow(2,(4608-e.period)/768);e.sample.step=s/o.getSampleStepping()}}},FINE_PORTA_DOWN:{representation:"E",handler:function(e,t,a,n,o){if(0===a){t&!0&&(e.porta.step=15&t),e.period+=e.porta.step*o.getTicksPerRow();var s=8363*Math.pow(2,(4608-e.period)/768);e.sample.step=s/o.getSampleStepping()}}},SET_GLISANDO:{representation:"E",handler:function(e,t,a){0===a&&console.log("Effect not supported: SET_GLISANDO")}},SET_VIBRATO:{representation:"E",handler:function(e,t,a){0===a&&console.log("Effect not supported: SET_VIBRATO")}},SET_FINETUNE:{representation:"E",handler:function(e,t,a){0===a&&null!==e.sample.sample&&(e.sample.sample.fineTune=15&t)}},SET_LOOP:{representation:"E",handler:function(e,t,a,n,o){0===a&&(0===(15&t)?e.loopMark=o.getCurrentRow():(0==e.loopCount?e.loopCount=15&t:e.loopCount--,e.loopCount>0&&o.setRowJump(e.loopMark)))}},SET_TREMOLO:{representation:"E",handler:function(e,t,a){0===a&&console.log("Effect not supported: SET_TREMOLO")}},SET_PAN_16:{representation:"E",handler:function(e,t,a){0===a&&(e.panning.pan=(15&t)/15)}},RETRIGGER:{representation:"E",handler:function(e,t,a){a%(15&t)===0&&e.sample.sample&&(e.sample.remain=e.sample.sample.sampleLength,e.sample.position=0)}},FINE_VOL_SLIDE_UP:{representation:"E",handler:function(e,t,a){0===a&&(e.volume.channelVolume=Math.min(e.volume.channelVolume+(15&t)/15,1))}},FINE_VOL_SLIDE_DOWN:{representation:"E",handler:function(e,t,a){0===a&&(e.volume.channelVolume=Math.max(0,e.volume.channelVolume-(15&t)/15))}},CUT_NOTE:{representation:"E",handler:function(e,t,a){a===(15&t)&&(e.volume.channelVolume=0)}},DELAY_NOTE:{representation:"E",handler:function(e,t,a){0===a&&(e.noteDelay=15&t)}},DELAY_PATTERN:{representation:"E",handler:function(e,t){0===e.patternDelay&&(e.patternDelay=(15&t)+1)}},SET_TEMPO_BPM:{representation:"F",handler:function(e,t,a,n,o){0===a&&(32>=t?Effects.SET_SPEED.handler(e,t,a,n,o):Effects.SET_TEMPO.handler(e,t,a,n,o))}},SET_SPEED:{representation:"F",handler:function(e,t,a,n,o){if(0===a)if(0!==t){o.setTicksPerRow(t);var s=24*o.getBpm()/o.getTicksPerRow(),r=s*o.getTicksPerRow();o.setSamplesPerTick(Math.round(o.getSampleRate()/(r/60)))}else o.stop(),o.resetPlayback()}},SET_TEMPO:{representation:"F",handler:function(e,t,a,n,o){if(0===a){o.setBpm(t);var s=24*o.getBpm()/o.getTicksPerRow(),r=s*o.getTicksPerRow();o.setSamplesPerTick(Math.round(o.getSampleRate()/(r/60)))}}},RETRIG_VOL_SLIDE:{representation:"R",handler:function(e,t,a){if(a%(15&t)===0&&e.sample.sample&&(e.sample.remain=e.sample.sample.sampleLength,e.sample.position=0),0===a&&0!==(240&t))e.volume.channelVolumeSlide=(240&t)>>4;else if(a>0){switch(e.volume.channelVolumeSlide){case 1:e.volume.channelVolume-=1/64;break;case 2:e.volume.channelVolume-=2/64;break;case 3:e.volume.channelVolume-=4/64;break;case 4:e.volume.channelVolume-=.125;break;case 5:e.volume.channelVolume-=.25;break;case 6:e.volume.channelVolume*=.67;break;case 7:e.volume.channelVolume*=.5;break;case 9:e.volume.channelVolume+=1/64;break;case 10:e.volume.channelVolume+=2/64;break;case 11:e.volume.channelVolume+=4/64;break;case 12:e.volume.channelVolume+=.125;break;case 13:e.volume.channelVolume+=.25;break;case 14:e.volume.channelVolume*=1.5;break;case 15:e.volume.channelVolume*=2}e.volume.channelVolume=Math.max(0,Math.min(e.volume.channelVolume,1))}}},SET_GLOBAL_VOLUME:{representation:"G",handler:function(e,t,a,n,o){0===a&&o.setMasterVolume(Math.max(0,Math.min(t/64,1)))}},GLOBAL_VOLUME_SLIDE:{representation:"H",handler:function(e,t,a,n,o){0===a&&0!==t&&o.setMasterVolSlide((0!=(240&t)?(240&t)>>4:-(15&t))/64),a>0&&0!==o.getMasterVolSlide()&&o.setMasterVolume(Math.max(0,Math.min(o.getMasterVolume()+o.getMasterVolSlide(),1)))}},ENVELOPE_POSITION:{representation:"L",handler:function(e,t,a){0===a&&(e.envelopePosition=t)}},PAN_SLIDE:{representation:"P",handler:function(e,t,a){0===a&&0!==t&&(e.panning.panSlide=((240&t)>0?(240&t)>>4:-(15&t))/64),a>0&&(e.panning.pan=Math.max(0,Math.min(e.panning.pan+e.panning.panSlide,1)))}},TREMOR:{representation:"T",handler:function(e,t,a){if(0===a&&0!==t)e.tremor.onCount=240&t,e.tremor.offCount=15&t,e.tremor.muted=!1;else{var n=e.tremor.onCount+e.tremor.offCount;e.tremor.muted=a%n>=e.tremor.onCount}}},FINE_VIBRATO:{representation:"U",handler:function(e,t,a,n,o){if(0===a&&0!==t&&(0!=(240&t)&&(e.vibrato.step=2*Math.PI*((240&t)>>4)*o.getTicksPerRow()/64),0!=(15&t)&&(e.vibrato.amplitude=8*(15&t)),e.vibrato.position=0),a%4==0){var s=Math.sin(e.vibrato.position)*e.vibrato.amplitude,r=8363*Math.pow(2,(4608-e.period+s)/768);e.sample.step=r/o.getSampleStepping(),e.vibrato.position+=e.vibrato.step}}},EXTRA_FINE_PORTA_UP:{representation:"X",handler:function(e,t,a,n,o){if(0===a){t&!0&&(e.porta.step=15&t),e.period-=e.porta.step;var s=8363*Math.pow(2,(4608-e.period)/768);e.sample.step=s/o.getSampleStepping()}}},EXTRA_FINE_PORTA_DOWN:{representation:"X",handler:function(e,t,a,n,o){if(0===a){t&!0&&(e.porta.step=15&t),e.period+=e.porta.step;var s=8363*Math.pow(2,(4608-e.period)/768);e.sample.step=s/o.getSampleStepping()}}},VOLUME_EFFECT:{representation:"V",handler:function(e,t,a,n,o){var s=(240&t)>>4,r=15&t;switch(s){case 5:Effects.VOLUME_SLIDE.handler(e,r,a,n,o);break;case 6:r<<=4,Effects.VOLUME_SLIDE.handler(e,r,a,n,o);break;case 7:r=240+r,Effects.VOLUME_SLIDE.handler(e,r,a,n,o);break;case 8:r=(r<<4)+15,Effects.VOLUME_SLIDE.handler(e,r,a,n,o);break;case 9:r<<=4,Effects.VIBRATO.handler(e,r,a,n,o);break;case 10:Effects.VIBRATO.handler(e,r,a,n,o);break;case 11:r=2*r+11,Effects.SET_PAN.handler(e,r,a,n,o);break;case 12:Effects.PAN_SLIDE.handler(e,r,a,n,o);break;case 13:r<<=4,Effects.PAN_SLIDE.handler(e,r,a,n,o);break;case 14:r*=4,Effects.TONE_PORTA.handler(e,r,a,n,o)}}}},ModTypes={MOD:0,S3M:1,IT:2,XM:3},SampleLoop={LOOP_NONE:0,LOOP_FORWARD:1,LOOP_PINGPONG:2},SampleFormat={FORMAT_8BIT:0,FORMAT_16BIT:2,TYPE_UNCOMPRESSED:0,TPYE_DELTA:2,TPYE_ADPCM:4},EnvelopeType={NONE:0,ON:1,SUSTAIN:2,LOOP:4},Envelope=function(){this.type=EnvelopeType.NONE,this.points=[];var e=-1,t=0;this.sustainPoint=0,this.loopBegin=0,this.loopEnd=0,this.addPoint=function(a,n,o,s,r){for(var l=a-e,i=(n-t)/l,p=0;l>p;p++)e++,t+=i,this.points.push(t);o&&(this.sustainPoint=e),s&&(this.loopBegin=e),r&&(this.loopEnd=e)},this.getValue=function(e,t,a){if(e=Math.round(e),0!=(this.type&EnvelopeType.SUSTAIN))return t?this.points[Math.min(e,this.points.length-1)]:this.points[Math.min(e,this.sustainPoint)];if(0!=(this.type&EnvelopeType.LOOP)){var n;return n=e>=this.loopBegin?this.loopBegin+(e-this.loopBegin)%(this.loopEnd-this.loopBegin):e,this.points[Math.min(n,this.points.length-1)]}return 0!=(this.type&EnvelopeType.ON)?this.points[Math.min(e,this.points.length-1)]:t?0:a}},Instrument=function(){this.name="",this.type=0,this.numSamples=0,this.sampleKeyMap=[],this.samples=[],this.volumeEnvelope=new Envelope,this.panningEnvelope=new Envelope;for(var e=0;96>e;e++)this.sampleKeyMap.push(0)},ModLoader=function(e){var t=new Module;t.type=ModTypes.MOD;var a=[1712,1616,1524,1440,1356,1280,1208,1140,1076,1016,960,906,856,808,762,720,678,640,604,570,538,508,480,453,428,404,381,360,339,320,302,285,269,254,240,226,214,202,190,180,170,160,151,143,135,127,120,113,107,101,95,90,85,80,75,71,67,63,60,56];switch(e.substring(1080,1084)){case"6CHN":t.channels=6;break;case"FLT8":case"8CHN":case"CD81":case"OKTA":t.channels=8;break;case"16CN":t.channels=16;break;case"32CN":t.channels=32;break;default:t.channels=4}t.name=e.substring(0,20),t.songLength=e.charCodeAt(950),t.restartPosition=e.charCodeAt(951);for(var n=0;31>n;n++){var o=e.substring(20+30*n,50+30*n),s=new Instrument,r=new Sample;r.name=o.substring(0,22),r.sampleLength=2*(256*o.charCodeAt(22)+o.charCodeAt(23)),r.fineTune=15&o.charCodeAt(24),r.volume=Math.min(o.charCodeAt(25),64)/64,r.loopStart=2*(256*o.charCodeAt(26)+o.charCodeAt(27)),r.loopLength=2*(256*o.charCodeAt(28)+o.charCodeAt(29)),r.loopType=r.loopLength>1?SampleLoop.LOOP_FORWARD:SampleLoop.LOOP_NONE,r.fineTune>7&&(r.fineTune-=16),r.fineTune*=16,s.name=r.name,s.samples.push(r),t.instruments.push(s)}for(var l=0,n=0;128>n;n++)t.orders[n]=e.charCodeAt(952+n),l=Math.max(l,t.orders[n]+1);for(var i=256*t.channels,n=0;l>n;n++){for(var p=e.substring(1084+n*i,1084+n*i+i),f=new Pattern(64,t.channels),c=0;64>c;c++)for(var h=0;h<t.channels;h++){var m=c*t.channels*4+4*h,u=p.charCodeAt(m),d=p.charCodeAt(m+1),E=p.charCodeAt(m+2),T=p.charCodeAt(m+3),v=256*(15&u)|d;if(0==v)f.note[c][h]=0;else if(v>a[0])f.note[c][h]=1;else if(v<=a[a.length-1])f.note[c][h]=60;else for(var O=0;O<a.length-1;O++)if(v==a[O]){f.note[c][h]=O+1;break}if(f.instrument[c][h]=240&u|(240&E)/16,f.volume[c][h]=-1,f.effectParam[c][h]=T,0==(15&E)&&0!=T)f.effect[c][h]=Effects.ARPEGGIO;else if(1==(15&E))f.effect[c][h]=Effects.PORTA_UP;else if(2==(15&E))f.effect[c][h]=Effects.PORTA_DOWN;else if(3==(15&E))f.effect[c][h]=Effects.TONE_PORTA;
else if(4==(15&E))f.effect[c][h]=Effects.VIBRATO;else if(5==(15&E))f.effect[c][h]=Effects.TONE_PORTA_VOL_SLIDE;else if(6==(15&E))f.effect[c][h]=Effects.VIBRATO_VOL_SLIDE;else if(7==(15&E))f.effect[c][h]=Effects.TREMOLO;else if(8==(15&E))f.effect[c][h]=Effects.SET_PAN;else if(9==(15&E))f.effect[c][h]=Effects.SAMPLE_OFFSET;else if(10==(15&E))f.effect[c][h]=Effects.VOLUME_SLIDE;else if(11==(15&E))f.effect[c][h]=Effects.POSITION_JUMP;else if(12==(15&E))f.effect[c][h]=Effects.SET_VOLUME;else if(13==(15&E))f.effect[c][h]=Effects.PATTERN_BREAK;else if(14==(15&E))switch((240&T)>>4){case 0:f.effect[c][h]=Effects.SET_FILTER;break;case 1:f.effect[c][h]=Effects.FINE_PORTA_UP;break;case 2:f.effect[c][h]=Effects.FINE_PORTA_DOWN;break;case 3:f.effect[c][h]=Effects.SET_GLISANDO;break;case 4:f.effect[c][h]=Effects.SET_VIBRATO;break;case 5:f.effect[c][h]=Effects.SET_FINETUNE;break;case 6:f.effect[c][h]=Effects.SET_LOOP;break;case 7:f.effect[c][h]=Effects.SET_TREMOLO;break;case 8:f.effect[c][h]=Effects.SET_PAN_16;break;case 9:f.effect[c][h]=Effects.RETRIGGER;break;case 10:f.effect[c][h]=Effects.FINE_VOL_SLIDE_UP;break;case 11:f.effect[c][h]=Effects.FINE_VOL_SLIDE_DOWN;break;case 12:f.effect[c][h]=Effects.CUT_NOTE;break;case 13:f.effect[c][h]=Effects.DELAY_NOTE;break;case 14:f.effect[c][h]=Effects.DELAY_PATTERN;break;default:f.effect[c][h]=Effects.NONE}else f.effect[c][h]=15==(15&E)?Effects.SET_TEMPO_BPM:Effects.NONE}t.patterns.push(f)}for(var A=l*i+1084,n=0;n<t.instruments.length;n++)t.instruments[n].samples[0].loadSample(e.substring(A,A+t.instruments[n].samples[0].sampleLength),!1,t.signedSample),t.instruments[n].samples[0].sample[0]=0,t.instruments[n].samples[0].sample[1]=0,A+=t.instruments[n].samples[0].sampleLength;return t},ChannelRegisters=function(){this.sample={sample:null,position:0,step:0,remain:0,reversed:!1},this.volume={channelVolume:0,sampleVolume:0,volumeSlide:0,envelope:null},this.panning={pan:.5,panSlide:0,envelope:null},this.porta={notePeriod:0,step:0},this.vibrato={position:0,step:0,amplitude:0},this.tremolo={position:0,step:0,amplitude:0,volume:1},this.tremor={onCount:0,offCount:0,muted:!1},this.isMuted=!1,this.note=0,this.period=0,this.noteDelay=0,this.loopMark=0,this.loopCount=0,this.tremorCount=0,this.envelopePos=0,this.noteReleased=!1,this.reset=function(){this.sample.sample=null,this.sample.position=0,this.sample.step=0,this.sample.remain=0,this.sample.reversed=!1,this.volume.channelVolume=0,this.volume.sampleVolume=0,this.volume.volumeSlide=0,this.volume.envelope=null,this.panning.pan=.5,this.panning.panSlide=0,this.panning.envelope=null,this.porta.notePeriod=0,this.porta.step=0,this.vibrato.position=0,this.vibrato.step=0,this.vibrato.amplitude=0,this.tremolo.position=0,this.tremolo.step=0,this.tremolo.amplitude=0,this.tremolo.volume=1,this.tremor.onCount=0,this.tremor.offCount=0,this.tremor.muted=!1,this.isMuted=!1,this.tremorMute=!1,this.note=0,this.period=0,this.noteDelay=0,this.loopMark=0,this.loopCount=0,this.envelopePos=0,this.noteReleased=!1}};