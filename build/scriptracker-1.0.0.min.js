/**
 * ScripTracker v1.0.0
 * Code by Maarten Janssen in 2013-2015
 *
 * http://scriptracker.cheerful.nl for a live demo
 * http://github.com/DhrBaksteen/ScripTracker for latest build and source
 *
 * Thanks for using this! :)
 */
"use strict";function ScripTracker(){function e(e){if(S)for(var n=e.outputBuffer,s=n.getChannelData(0),r=n.getChannelData(1),l=0;l<n.length;l++){for(var p=0,f=0,u=0;u<o.channels;u++){var c=N[u];if(c.sample.sample){var m=c.sample.sample.sample[Math.floor(c.sample.position)],d=c.volume.envelope.getValue(c.envelopePos,c.noteReleased,1),T=c.panning.envelope.getValue(c.envelopePos,c.noteReleased,.5),O=d*c.tremolo.volume*c.volume.channelVolume,P=Math.max(0,Math.min(c.panning.pan+(T-.5)*((2-Math.abs(c.panning.pan-2))/.5),1));c.envelopePos+=1/E,c.isMuted||c.tremor.muted||(c.panning.pan<=1?(p+=m*(1-P)*O,f+=m*P*O):(p+=.5*m*O,f-=.5*m*O)),c.sample.position+=c.sample.reversed?-c.sample.step:c.sample.step,c.sample.remain-=Math.abs(c.sample.step),c.sample.remain<=0&&(c.sample.sample.loopType===Module.Sample.SampleLoop.LOOP_FORWARD?(c.sample.position=c.sample.sample.loopStart-c.sample.remain,c.sample.remain=c.sample.sample.loopLength+c.sample.remain):c.sample.sample.loopType===Module.Sample.SampleLoop.LOOP_PINGPONG?(c.sample.position=Math.max(c.sample.sample.loopStart,c.sample.position),c.sample.position=Math.min(c.sample.sample.loopStart+c.sample.sample.loopLength-1,c.sample.position),c.sample.remain=c.sample.sample.loopLength,c.sample.reversed=!c.sample.reversed):(c.sample.position=c.sample.sample.sampleLength-1,c.sample.step=0))}}s[l]=p*M,r[l]=f*M,v++,v===E&&(v=0,i++,i===h&&a(),t())}}function t(){0===i&&(0===l&&n.dispatchEvent(ScripTracker.Events.order,n),n.dispatchEvent(ScripTracker.Events.row,n));for(var e=0;e<o.channels;e++){var t=N[e],a=s.note[l][e],r=s.instrument[l][e],p=s.volume[l][e],f=s.effect[l][e],u=s.effectParam[l][e];if(0===i){if(0!==r){t.instrument=r,n.dispatchEvent(ScripTracker.Events.instrument,n,e,t.instrument,a,f,u);var c=o.instruments[r-1];if(c){var m=c.sampleKeyMap[a];c.samples[m]&&(t.sample.sample=c.samples[m],t.sample.remain=t.sample.sample.sampleLength,t.volume.sampleVolume=t.sample.sample.volume),t.sample.position=0,t.sample.reversed=!1,t.volume.envelope=c.volumeEnvelope,t.panning.envelope=c.panningEnvelope,t.envelopePos=0,t.noteReleased=!1,"mod"!==o.type&&t.sample.sample&&(t.panning.pan=t.sample.sample.panning),t.sample.sample&&t.sample.sample.sampleLength<1&&(t.sample.sample=null)}else t.sample.sample=null}if(0!==a&&f!==Effects.TONE_PORTA&&f!==Effects.TONE_PORTA_VOL_SLIDE)if(97===a)t.note=a,t.noteReleased=!0;else if(t.note=a-1,null!==t.sample.sample){t.period=7680-64*(a-26-t.sample.sample.basePeriod)-t.sample.sample.fineTune/2;var d=8363*Math.pow(2,(4608-t.period)/768);t.sample.position=0,t.volume.sampleVolume=t.sample.sample.volume,t.sample.remain=t.sample.sample.sampleLength,t.sample.step=d/T,t.sample.reversed=!1,t.noteDelay=0,0===r&&n.dispatchEvent(ScripTracker.Events.instrument,n,e,t.instrument,a,f,u)}t.tremolo.volume=1,t.tremor.muted=!1,p>=0&&64>=p?t.volume.channelVolume=p/64:97>a&&0!==r&&(t.volume.channelVolume=t.volume.sampleVolume),f!==Effects.NONE&&n.dispatchEvent(ScripTracker.Events.effect,n,e,t.instrument,a,f,u)}p>64&&Effects.VOLUME_EFFECT.handler(t,p,i,e,n),f.handler(t,u,i,e,n)}}function a(){if(-1===L||R||(l=-1,r=Math.min(o.songLength-1,L),s=o.patterns[o.orders[r]]),-1!==P&&(l=P-1,!R&&-1===L)){for(r++;254===o.orders[r]&&r<o.songLength;)r++;(r===o.songLength||255==o.orders[r])&&(r=o.restartPosition),s=o.patterns[o.orders[r]]}if(-1!==g&&(l=g-1,g=-1),2>_?(L=-1,P=-1,i=0,_=0,l++):_--,!s)return n.dispatchEvent(ScripTracker.Events.songEnded,n),n.stop(),n.rewind(),void n.resetPlayback();if(l===s.rows){for(l=0,R||r++;254===o.orders[r]&&r<o.songLength;)r++;(r>=o.songLength||255===o.orders[r])&&(n.dispatchEvent(ScripTracker.Events.songEnded,n),r=o.restartPosition,n.resetPlayback()),s=o.patterns[o.orders[r]]}}for(var n=this,o=null,s=null,r=0,l=0,i=0,p=null,f=null,u=null,c=0,m=4096,d=0,h=0,E=0,v=0,T=0,S=!1,M=1,O=0,P=-1,L=-1,g=-1,_=0,R=!1,N=[],b=0;32>b;b++)N[b]=new ChannelRegisters;var A={SONG_LOADED:[],PLAY:[],STOP:[],SONG_END:[],NEW_ROW:[],NEW_ORDER:[],INSTRUMENT:[],EFFECT:[]};if("undefined"!=typeof AudioContext)p=new AudioContext;else{if("undefined"==typeof webkitAudioContext)return void alert("No audio context!");p=new webkitAudioContext}c=p.sampleRate,T=3*Math.round(.02*c),f=p.createBufferSource(),u=p.createScriptProcessor(m,1,2),u.onaudioprocess=e,f.start(0),this.loadModule=function(e){if(o=e,"mod"==o.type)for(var t=0;t<o.channels;t++)N[t].panning.pan=t%2==0?.7:.3;this.resetPlayback(),this.dispatchEvent(ScripTracker.Events.playerReady,this)},this.load=function(e){var t=e.split(".").pop().toLowerCase(),a=new XMLHttpRequest;a.onload=function(){var e=a.response;if(e)switch(e=new Uint8Array(e),t){case"mod":this.loadModule(ModuleLoaders.loadMOD(e));break;case"s3m":this.loadModule(ModuleLoaders.loadS3M(e));break;case"xm":this.loadModule(ModuleLoaders.loadXM(e));break;default:return}}.bind(this),a.open("get",e,!0),a.responseType="arraybuffer",a.send()},this.resetPlayback=function(){for(var e=0;32>e;e++)N[e].reset();M=.9,O=0,P=-1,L=-1,g=-1,_=0,r=0,l=0,i=0,v=0,s=o.patterns[o.orders[r]],Effects.SET_TEMPO.handler(N[0],o.defaultBPM,0,0,this),Effects.SET_SPEED.handler(N[0],o.defaultTempo,0,0,this)},this.play=function(){S||null==o||(this.dispatchEvent(ScripTracker.Events.play,this),t(),f.connect(u),u.connect(p.destination),S=!0)},this.debug=function(){f.stop()},this.stop=function(){u.disconnect(p.destination),f.disconnect(u),S=!1,this.dispatchEvent(ScripTracker.Events.stop,this)},this.prevOrder=function(){r-1>=0&&254!=o.orders[r]&&(r--,s=o.patterns[o.orders[r]]),l=0,i=0,v=0;for(var e=0;e<o.channels;e++)N[e].reset();t()},this.nextOrder=function(){r<o.orders.length-1&&(r++,s=o.patterns[o.orders[r]]),l=0,i=0,v=0;for(var e=0;e<o.channels;e++)N[e].reset();t()},this.restartOrder=function(){l=0,i=0,v=0;for(var e=0;e<o.channels;e++)N[e].reset();t()},this.rewind=function(){r=0,l=0,i=0,null!=o&&(s=o.patterns[o.orders[r]])},this.isMuted=function(e){return N[e].isMuted},this.isPatternLoop=function(){return R},this.isPlaying=function(){return S},this.setMute=function(e,t){N[e].isMuted=t},this.setPatternLoop=function(e){R=e},this.getSongName=function(){return o.name},this.getCurrentOrder=function(){return r+1},this.getCurrentPattern=function(){return o.orders[r]},this.getSongLength=function(){return o.songLength},this.getCurrentBPM=function(){return d},this.getCurrentTicks=function(){return h},this.getCurrentRow=function(){return l},this.getPatternRows=function(){return s.rows},this.getChannelVolume=function(e){return N[e].volume.sampleVolume*N[e].volume.channelVolume*M},this.getChannelInstrument=function(e){var t=N[e];return t.sample.sample&&t.sample.step>0?t.sample.sample.name:""},this.getNoteInfo=function(e,t){return s.toText(t,e,o.type)},this.dump=function(){console.log(registers),console.log(s)},this.getSamplesPerTick=function(){return E},this.setSamplesPerTick=function(e){E=e},this.getBpm=function(){return d},this.setBpm=function(e){d=e},this.getTicksPerRow=function(){return h},this.setTicksPerRow=function(e){h=e},this.getSampleRate=function(){return c},this.getSampleStepping=function(){return T},this.getNote=function(e){return s.note[l][e]},this.getPatternVolume=function(e){return s.volume[l][e]},this.setBreakPattern=function(e){P=e},this.getMasterVolume=function(){return M},this.setMasterVolume=function(e){M=e},this.getMasterVolSlide=function(){return O},this.setMasterVolSlide=function(e){O=e},this.setRowJump=function(e){g=e},this.setOrderJump=function(e){L=e},this.on=function(e,t){switch(e){case ScripTracker.Events.instrument:case ScripTracker.Events.effect:A[e].push({handler:arguments[2],param:arguments[1]});break;default:A[e].push(t)}},this.off=function(e,t){var a=A[e];switch(e){case ScripTracker.Events.instrument:case ScripTracker.Events.effect:for(var n=0;n<a.length;n++)(1===arguments.length||a[n].handler===arguments[2]&&a[n].param===arguments[1])&&(a.splice(n,1),n--);break;default:for(var n=0;n<a.length;n++)t&&a[n]!==t||(a.splice(n,1),n--)}},this.dispatchEvent=function(e,t,a,n,o,s,r){var l=A[e];switch(e){case ScripTracker.Events.playerReady:for(var i=0;i<l.length;i++)l[i](t,t.getSongName(),t.getSongLength());break;case ScripTracker.Events.order:for(var i=0;i<l.length;i++)l[i](t,t.getCurrentOrder(),t.getSongLength(),t.getCurrentPattern());break;case ScripTracker.Events.row:for(var i=0;i<l.length;i++)l[i](t,t.getCurrentRow(),t.getPatternRows());break;case ScripTracker.Events.instrument:for(var i=0;i<l.length;i++)l[i].param===n&&l[i].handler(t,n,a,o,s,r);break;case ScripTracker.Events.effect:for(var i=0;i<l.length;i++)l[i].param===s&&l[i].handler(t,s,r,a,n,o);break;default:for(var i=0;i<l.length;i++)l[i](t)}}}var Module=function(){this.name="",this.type=null,this.songLength=0,this.restartPosition=0,this.orders=[],this.channels=0,this.patternCount=0,this.patterns=[],this.instrumentCount=0,this.instruments=[],this.signedSample=!0,this.defaultTempo=6,this.defaultBPM=125,this.defaultVolume=1};Module.Types={MOD:"mod",S3M:"s3m",IT:"it",XM:"xm"},Module.Pattern=function(e,t){this.patternIndex=0,this.rows=e,this.columns=t,this.note=[],this.instrument=[],this.volume=[],this.effect=[],this.effectParam=[];for(var a=0;e>a;a++){this.note[a]=[],this.instrument[a]=[],this.volume[a]=[],this.effect[a]=[],this.effectParam[a]=[];for(var n=0;t>n;n++)this.note[a][n]=0,this.instrument[a][n]=0,this.volume[a][n]=-1,this.effect[a][n]=Effects.NONE,this.effectParam[a][n]=0}},Module.Pattern.prototype.toText=function(e,t){var a=["C-","C#","D-","D#","E-","F-","F#","G-","G#","A-","A#","B-"],n="0123456789ABCDEF",o="DCBAUHPLRG",s="";if(0>e||e>=this.rows||0>t||t>=this.columns)return"... .. .. ...";if(0==this.note[e][t]?s+="...":97==this.note[e][t]?s+="===":(s+=a[(this.note[e][t]-1)%12],s+=Math.floor((this.note[e][t]-1)/12)),s+=" ",0!=this.instrument[e][t]?(s+=n.charAt(Math.floor(this.instrument[e][t]/16)),s+=n.charAt(this.instrument[e][t]%16)):s+="..",s+=" ",this.volume[e][t]>-1){var r=this.volume[e][t];s+=r>=80?o.charAt(Math.floor((r-80)/16)):n.charAt(Math.floor(r/16)),s+=n.charAt(r%16)}else s+="..";return s+=" ",this.effect[e][t]!=Effects.NONE?(s+=this.effect[e][t].representation,11==s.length&&(s+=n.charAt(Math.floor(this.effectParam[e][t]/16))),s+=n.charAt(this.effectParam[e][t]%16)):s+="...",s},Module.Sample=function(){this.sampleIndex=0,this.name="",this.sampleLength=0,this.loopStart=0,this.loopLength=0,this.loopType=Module.Sample.SampleLoop.LOOP_NONE,this.dataType=Module.Sample.SampleFormat.FORMAT_8BIT|Module.Sample.SampleFormat.TYPE_UNCOMPRESSED,this.volume=1,this.panning=.5,this.basePeriod=0,this.fineTune=0,this.sample=[],this.loadSample=function(e,t,a){this.sample=[];for(var n=0,o=0;o<this.sampleLength;o++){if(t){var s=ModuleLoader.readWord(e,2*o);o++,n=a?32768>s?s/32767:-((65535^s)+1)/32768:s/32768-1}else{var r=e[o];n=a?128>r?r/127:-((255^r)+1)/128:r/128-1}this.sample.push(n)}},this.loadStereoSample=function(e,t,a){this.loadSample(sampledata.subarray(0,this.sampleLength*t?2:1),t,a);var n=this.sample;this.loadSample(sampledata.subarray(this.sampleLength*t?2:1),t,a);var o=this.sample;this.sample=[];for(var s=0;s<this.sampleLength;s++)this.sample.push((n[s]+o[s])/2)},this.loadDeltaSample=function(e,t){for(var a=0,n=0;n<this.sampleLength;n++){if(t){var o=ModuleLoaders.readWord(e,n++);o>32767&&(o=-(65536-o)),a+=o/32768}else{var s=e[n];s>127&&(s=-(256-s)),a+=s/128}-1>a&&(a=1+(a+1)),a>1&&(a=-1+(a-1)),this.sample.push(a)}},this.loadAdpcmSample=function(e,t){console.log("adpcm sample");var a=[];this.sample=[];for(var n=0;16>n;n++)if(t){var o=ModuleLoaders.readWord(e,n++);a[n]=32768>o?o/32767:-((65535^o)+1)/32768}else{var s=e[n];a[n]=128>s?s/127:-((255^s)+1)/128}for(var r=0,n=0;n<Math.floor(this.sampleLength/2);n++)r+=a[15&e[n+t?32:16]],this.sample.push(r),r+=a[e[n+t?32:16]>>4],this.sample.push(r)}},Module.Sample.SampleLoop={LOOP_NONE:0,LOOP_FORWARD:1,LOOP_PINGPONG:2},Module.Sample.SampleFormat={FORMAT_8BIT:0,FORMAT_16BIT:2,TYPE_UNCOMPRESSED:0,TPYE_DELTA:2,TPYE_ADPCM:4};var Effects={NONE:{representation:".",handler:function(){}},ARPEGGIO:{representation:"0",handler:function(e,t,a,n,o){var s;a%3===0?s=0:a%3===1?s=64*((240&t)>>4):a%3===2&&(s=64*(15&t));var r=8363*Math.pow(2,(4608-e.period+s)/768);e.sample.step=r/o.getSampleStepping()}},PORTA_UP:{representation:"1",handler:function(e,t,a,n,o){if(0===a&&0!==t)e.porta.step=t;else if(a>0){e.period-=e.porta.step*o.getTicksPerRow();var s=8363*Math.pow(2,(4608-e.period)/768);e.sample.step=s/o.getSampleStepping()}}},PORTA_DOWN:{representation:"2",handler:function(e,t,a,n,o){if(0===a&&0!==t)e.porta.step=t;else if(a>0){e.period+=e.porta.step*o.getTicksPerRow();var s=8363*Math.pow(2,(4608-e.period)/768);e.sample.step=s/o.getSampleStepping()}}},TONE_PORTA:{representation:"3",handler:function(e,t,a,n,o){if(e.sample.sample){0===a&&0!==t&&(e.porta.step=t),0===a&&0!==o.getNote(n)&&(e.porta.notePeriod=7680-64*(o.getNote(n)-26-e.sample.sample.basePeriod)-e.sample.sample.fineTune/2),e.period<e.porta.notePeriod?(e.period+=e.porta.step*o.getTicksPerRow(),e.period>e.porta.notePeriod&&(e.period=e.porta.notePeriod)):e.period>e.porta.notePeriod&&(e.period-=e.porta.step*o.getTicksPerRow(),e.period<e.porta.notePeriod&&(e.period=e.porta.notePeriod));var s=8363*Math.pow(2,(4608-e.period)/768);e.sample.step=s/o.getSampleStepping()}}},VIBRATO:{representation:"4",handler:function(e,t,a,n,o){0===a&&0!==t&&(0!==(240&t)&&(e.vibrato.step=2*Math.PI*((240&t)>>4)*o.getTicksPerRow()/64),0!==(15&t)&&(e.vibrato.amplitude=2*(15&t)),e.vibrato.position=0);var s=Math.sin(e.vibrato.position)*e.vibrato.amplitude,r=8363*Math.pow(2,(4608-e.period+s)/768);e.sample.step=r/o.getSampleStepping(),e.vibrato.position+=e.vibrato.step}},TONE_PORTA_VOL_SLIDE:{representation:"5",handler:function(e,t,a,n,o){if(e.sample.sample){0===a&&0!=o.getNote(n)&&(e.porta.notePeriod=7680-64*(o.getNote(n)-26-e.sample.sample.basePeriod)-e.sample.sample.fineTune/2),e.period<e.porta.notePeriod?(e.period+=e.porta.step,e.period>e.porta.notePeriod&&(e.period=e.porta.notePeriod)):e.period>e.porta.notePeriod&&(e.period-=e.porta.step,e.period<e.porta.notePeriod&&(e.period=e.porta.notePeriod));var s=8363*Math.pow(2,(4608-e.period)/768);e.sample.step=s/o.getSampleStepping();var r=(0!=(240&t)?(240&t)>>4:-(15&t))/64;e.volume.channelVolume=Math.max(0,Math.min(e.volume.channelVolume+r,1))}}},VIBRATO_VOL_SLIDE:{representation:"6",handler:function(e,t,a,n,o){0===a&&0!==t&&(e.volume.channelVolumeSlide=t);var s=Math.sin(e.vibrato.position)*e.vibrato.amplitude,r=8363*Math.pow(2,(4608-e.period+s)/768);e.sample.step=r/o.getSampleStepping(),e.vibrato.position+=e.vibrato.step;var l=(0!=(240&e.volume.channelVolumeSlide)?(240&e.volume.channelVolumeSlide)>>4:-(15&e.volume.channelVolumeSlide))/64;e.volume.channelVolume=Math.max(0,Math.min(e.volume.channelVolume+l,1))}},TREMOLO:{representation:"7",handler:function(e,t,a,n,o){0===a&&0!==t&&(0!==(240&t)&&(e.tremolo.step=2*Math.PI*((240&t)>>4)*o.getTicksPerRow()/64),0!==(15&t)&&(e.tremolo.amplitude=(15&t)/30),e.tremolo.position=0),e.tremolo.volume=1-Math.sin(e.tremolo.position)*e.tremolo.amplitude,e.tremolo.position+=e.tremolo.step}},SET_PAN:{representation:"8",handler:function(e,t,a){0===a&&(e.panning.pan=1-t/128)}},SAMPLE_OFFSET:{representation:"9",handler:function(e,t,a){0===a&&(e.sample.position=256*t,e.sample.remain-=256*t)}},VOLUME_SLIDE:{representation:"A",handler:function(e,t,a){if(0===a&&0!==t&&(e.volume.channelVolumeSlide=t),a>0&&0!==e.volume.channelVolumeSlide)if(240===(240&e.volume.channelVolumeSlide)&&0!==(15&e.volume.channelVolumeSlide)){if(1===a){var n=(15&e.volume.channelVolumeSlide)/64;e.volume.channelVolume=Math.max(0,e.volume.channelVolume-n)}}else if(15===(15&e.volume.channelVolumeSlide)&&0!==(240&e.volume.channelVolumeSlide)){if(1===a){var n=((240&e.volume.channelVolumeSlide)>>4)/64;e.volume.channelVolume=Math.min(1,e.volume.channelVolume+n)}}else{var n=(0!=(240&e.volume.channelVolumeSlide)?(240&e.volume.channelVolumeSlide)>>4:-(15&e.volume.channelVolumeSlide))/64;e.volume.channelVolume=Math.max(0,Math.min(e.volume.channelVolume+n,1))}}},POSITION_JUMP:{representation:"B",handler:function(e,t,a,n,o){0===a&&o.setOrderJump(t)}},SET_VOLUME:{representation:"C",handler:function(e,t,a){0===a&&(e.volume.channelVolume=Math.max(0,Math.min(t/64,1)))}},PATTERN_BREAK:{representation:"D",handler:function(e,t,a,n,o){0===a&&o.setBreakPattern(10*((240&t)>>4)+(15&t))}},SET_FILTER:{representation:"E",handler:function(e,t,a){0===a&&console.log("Effect not supported: SET_FILTER")}},FINE_PORTA_UP:{representation:"E",handler:function(e,t,a,n,o){if(0===a){t&!0&&(e.porta.step=15&t),e.period-=e.porta.step*o.getTicksPerRow();var s=8363*Math.pow(2,(4608-e.period)/768);e.sample.step=s/o.getSampleStepping()}}},FINE_PORTA_DOWN:{representation:"E",handler:function(e,t,a,n,o){if(0===a){t&!0&&(e.porta.step=15&t),e.period+=e.porta.step*o.getTicksPerRow();var s=8363*Math.pow(2,(4608-e.period)/768);e.sample.step=s/o.getSampleStepping()}}},SET_GLISANDO:{representation:"E",handler:function(e,t,a){0===a&&console.log("Effect not supported: SET_GLISANDO")}},SET_VIBRATO:{representation:"E",handler:function(e,t,a){0===a&&console.log("Effect not supported: SET_VIBRATO")}},SET_FINETUNE:{representation:"E",handler:function(e,t,a){0===a&&null!==e.sample.sample&&(e.sample.sample.fineTune=15&t)}},SET_LOOP:{representation:"E",handler:function(e,t,a,n,o){0===a&&(0===(15&t)?e.loopMark=o.getCurrentRow():(0==e.loopCount?e.loopCount=15&t:e.loopCount--,e.loopCount>0&&o.setRowJump(e.loopMark)))}},SET_TREMOLO:{representation:"E",handler:function(e,t,a){0===a&&console.log("Effect not supported: SET_TREMOLO")}},SET_PAN_16:{representation:"E",handler:function(e,t,a){0===a&&(e.panning.pan=(15&t)/15)}},RETRIGGER:{representation:"E",handler:function(e,t,a,n,o){a%(15&t)===0&&e.sample.sample&&(e.sample.remain=e.sample.sample.sampleLength,e.sample.position=0,o.dispatchEvent(ScripTracker.Events.instrument,o,n,e.instrument,e.note,Effects.RETRIGGER,t))}},FINE_VOL_SLIDE_UP:{representation:"E",handler:function(e,t,a){0===a&&(e.volume.channelVolume=Math.min(e.volume.channelVolume+(15&t)/15,1))}},FINE_VOL_SLIDE_DOWN:{representation:"E",handler:function(e,t,a){0===a&&(e.volume.channelVolume=Math.max(0,e.volume.channelVolume-(15&t)/15))}},CUT_NOTE:{representation:"E",handler:function(e,t,a){a===(15&t)&&(e.volume.channelVolume=0)}},DELAY_NOTE:{representation:"E",handler:function(e,t,a){0===a&&(e.noteDelay=15&t)}},DELAY_PATTERN:{representation:"E",handler:function(e,t){0===e.patternDelay&&(e.patternDelay=(15&t)+1)}},SET_TEMPO_BPM:{representation:"F",handler:function(e,t,a,n,o){0===a&&(32>=t?Effects.SET_SPEED.handler(e,t,a,n,o):Effects.SET_TEMPO.handler(e,t,a,n,o))}},SET_SPEED:{representation:"F",handler:function(e,t,a,n,o){if(0===a)if(0!==t){o.setTicksPerRow(t);var s=24*o.getBpm()/o.getTicksPerRow(),r=s*o.getTicksPerRow();o.setSamplesPerTick(Math.round(o.getSampleRate()/(r/60)))}else o.stop(),o.resetPlayback()}},SET_TEMPO:{representation:"F",handler:function(e,t,a,n,o){if(0===a){o.setBpm(t);var s=24*o.getBpm()/o.getTicksPerRow(),r=s*o.getTicksPerRow();o.setSamplesPerTick(Math.round(o.getSampleRate()/(r/60)))}}},RETRIG_VOL_SLIDE:{representation:"R",handler:function(e,t,a){if(a%(15&t)===0&&e.sample.sample&&(e.sample.remain=e.sample.sample.sampleLength,e.sample.position=0),0===a&&0!==(240&t))e.volume.channelVolumeSlide=(240&t)>>4;else if(a>0){switch(e.volume.channelVolumeSlide){case 1:e.volume.channelVolume-=1/64;break;case 2:e.volume.channelVolume-=2/64;break;case 3:e.volume.channelVolume-=4/64;break;case 4:e.volume.channelVolume-=.125;break;case 5:e.volume.channelVolume-=.25;break;case 6:e.volume.channelVolume*=.67;break;case 7:e.volume.channelVolume*=.5;break;case 9:e.volume.channelVolume+=1/64;break;case 10:e.volume.channelVolume+=2/64;break;case 11:e.volume.channelVolume+=4/64;break;case 12:e.volume.channelVolume+=.125;break;case 13:e.volume.channelVolume+=.25;break;case 14:e.volume.channelVolume*=1.5;break;case 15:e.volume.channelVolume*=2}e.volume.channelVolume=Math.max(0,Math.min(e.volume.channelVolume,1))}}},SET_GLOBAL_VOLUME:{representation:"G",handler:function(e,t,a,n,o){0===a&&o.setMasterVolume(Math.max(0,Math.min(t/64,1)))}},GLOBAL_VOLUME_SLIDE:{representation:"H",handler:function(e,t,a,n,o){0===a&&0!==t&&o.setMasterVolSlide((0!=(240&t)?(240&t)>>4:-(15&t))/64),a>0&&0!==o.getMasterVolSlide()&&o.setMasterVolume(Math.max(0,Math.min(o.getMasterVolume()+o.getMasterVolSlide(),1)))}},ENVELOPE_POSITION:{representation:"L",handler:function(e,t,a){0===a&&(e.envelopePosition=t)}},PAN_SLIDE:{representation:"P",handler:function(e,t,a){0===a&&0!==t&&(e.panning.panSlide=((240&t)>0?(240&t)>>4:-(15&t))/64),a>0&&(e.panning.pan=Math.max(0,Math.min(e.panning.pan+e.panning.panSlide,1)))}},TREMOR:{representation:"T",handler:function(e,t,a){if(0===a&&0!==t)e.tremor.onCount=240&t,e.tremor.offCount=15&t,e.tremor.muted=!1;else{var n=e.tremor.onCount+e.tremor.offCount;e.tremor.muted=a%n>=e.tremor.onCount}}},FINE_VIBRATO:{representation:"U",handler:function(e,t,a,n,o){if(0===a&&0!==t&&(0!=(240&t)&&(e.vibrato.step=2*Math.PI*((240&t)>>4)*o.getTicksPerRow()/64),0!=(15&t)&&(e.vibrato.amplitude=8*(15&t)),e.vibrato.position=0),a%4==0){var s=Math.sin(e.vibrato.position)*e.vibrato.amplitude,r=8363*Math.pow(2,(4608-e.period+s)/768);e.sample.step=r/o.getSampleStepping(),e.vibrato.position+=e.vibrato.step}}},EXTRA_FINE_PORTA_UP:{representation:"X",handler:function(e,t,a,n,o){if(0===a){t&!0&&(e.porta.step=15&t),e.period-=e.porta.step;var s=8363*Math.pow(2,(4608-e.period)/768);e.sample.step=s/o.getSampleStepping()}}},EXTRA_FINE_PORTA_DOWN:{representation:"X",handler:function(e,t,a,n,o){if(0===a){t&!0&&(e.porta.step=15&t),e.period+=e.porta.step;var s=8363*Math.pow(2,(4608-e.period)/768);e.sample.step=s/o.getSampleStepping()}}},VOLUME_EFFECT:{representation:"V",handler:function(e,t,a,n,o){var s=(240&t)>>4,r=15&t;switch(s){case 5:Effects.VOLUME_SLIDE.handler(e,r,a,n,o);break;case 6:r<<=4,Effects.VOLUME_SLIDE.handler(e,r,a,n,o);break;case 7:r=240+r,Effects.VOLUME_SLIDE.handler(e,r,a,n,o);break;case 8:r=(r<<4)+15,Effects.VOLUME_SLIDE.handler(e,r,a,n,o);break;case 9:r<<=4,Effects.VIBRATO.handler(e,r,a,n,o);break;case 10:Effects.VIBRATO.handler(e,r,a,n,o);break;case 11:r=2*r+11,Effects.SET_PAN.handler(e,r,a,n,o);break;case 12:Effects.PAN_SLIDE.handler(e,r,a,n,o);break;case 13:r<<=4,Effects.PAN_SLIDE.handler(e,r,a,n,o);break;case 14:r*=4,Effects.TONE_PORTA.handler(e,r,a,n,o)}}}};Module.Envelope=function(){this.type=Module.Envelope.EnvelopeType.NONE,this.points=[],this.lastPosition=-1,this.lastValue=0,this.sustainPoint=0,this.loopBegin=0,this.loopEnd=0},Module.Envelope.EnvelopeType={NONE:0,ON:1,SUSTAIN:2,LOOP:4},Module.Envelope.prototype.addPoint=function(e,t,a,n,o){for(var s=e-this.lastPosition,r=(t-this.lastValue)/s,l=0;s>l;l++)this.lastPosition++,this.lastValue+=r,this.points.push(this.lastValue);a&&(this.sustainPoint=this.lastPosition),n&&(this.loopBegin=this.lastPosition),o&&(this.loopEnd=this.lastPosition)},Module.Envelope.prototype.getValue=function(e,t,a){if(e=Math.round(e),0!=(this.type&Module.Envelope.EnvelopeType.SUSTAIN))return t?this.points[Math.min(e,this.points.length-1)]:this.points[Math.min(e,this.sustainPoint)];if(0!=(this.type&Module.Envelope.EnvelopeType.LOOP)){var n;return n=e>=this.loopBegin?this.loopBegin+(e-this.loopBegin)%(this.loopEnd-this.loopBegin):e,this.points[Math.min(n,this.points.length-1)]}return 0!=(this.type&Module.Envelope.EnvelopeType.ON)?this.points[Math.min(e,this.points.length-1)]:t?0:a},Module.Instrument=function(){this.name="",this.type=0,this.numSamples=0,this.sampleKeyMap=[],this.samples=[],this.volumeEnvelope=new Module.Envelope,this.panningEnvelope=new Module.Envelope;for(var e=0;96>e;e++)this.sampleKeyMap.push(0)};var ModuleLoaders={readWord:function(e,t){return e[t]+(e[t+1]<<8)},readWordBE:function(e,t){return(e[t]<<8)+e[t+1]},readDWord:function(e,t){return e[t]+(e[t+1]<<8)+(e[t+2]<<16)+(e[t+3]<<24)},readString:function(e,t,a){var n="";if(a)for(var o=0;a>o;o++)n+=String.fromCharCode(e[t+o]);else for(;e[t];)n+=String.fromCharCode(e[t++]);return n}};ModuleLoaders.loadMOD=function(e){var t=new Module;t.type=Module.Types.MOD;var a=[1712,1616,1524,1440,1356,1280,1208,1140,1076,1016,960,906,856,808,762,720,678,640,604,570,538,508,480,453,428,404,381,360,339,320,302,285,269,254,240,226,214,202,190,180,170,160,151,143,135,127,120,113,107,101,95,90,85,80,75,71,67,63,60,56];switch(ModuleLoaders.readString(e,1080,4)){case"6CHN":t.channels=6;break;case"FLT8":case"8CHN":case"CD81":case"OKTA":t.channels=8;break;case"16CN":t.channels=16;break;case"32CN":t.channels=32;break;default:t.channels=4}t.name=ModuleLoaders.readString(e,0,20),t.songLength=e[950],t.restartPosition=e[951];for(var n=0;31>n;n++){var o=e.subarray(20+30*n,50+30*n),s=new Module.Instrument,r=new Module.Sample;r.name=ModuleLoaders.readString(o,0,22),r.sampleLength=2*ModuleLoaders.readWordBE(o,22),r.fineTune=15&o[24],r.volume=Math.min(o[25],64)/64,r.loopStart=2*ModuleLoaders.readWordBE(o,26),r.loopLength=2*ModuleLoaders.readWordBE(o,28),r.loopType=r.loopLength>1?Module.Sample.SampleLoop.LOOP_FORWARD:Module.Sample.SampleLoop.LOOP_NONE,r.fineTune>7&&(r.fineTune-=16),r.fineTune*=16,s.name=r.name,s.samples.push(r),t.instruments.push(s)}for(var l=0,n=0;128>n;n++)t.orders[n]=e[952+n],l=Math.max(l,t.orders[n]+1);for(var i=256*t.channels,n=0;l>n;n++){for(var p=e.subarray(1084+n*i,1084+n*i+i),f=new Module.Pattern(64,t.channels),u=0;64>u;u++)for(var c=0;c<t.channels;c++){var m=u*t.channels*4+4*c,d=p[m],h=p[m+1],E=p[m+2],v=p[m+3],T=256*(15&d)|h;if(0==T)f.note[u][c]=0;else if(T>a[0])f.note[u][c]=1;else if(T<=a[a.length-1])f.note[u][c]=60;else for(var S=0;S<a.length-1;S++)if(T==a[S]){f.note[u][c]=S+1;break}if(f.instrument[u][c]=240&d|(240&E)/16,f.volume[u][c]=-1,f.effectParam[u][c]=v,0==(15&E)&&0!=v)f.effect[u][c]=Effects.ARPEGGIO;else if(1==(15&E))f.effect[u][c]=Effects.PORTA_UP;else if(2==(15&E))f.effect[u][c]=Effects.PORTA_DOWN;else if(3==(15&E))f.effect[u][c]=Effects.TONE_PORTA;else if(4==(15&E))f.effect[u][c]=Effects.VIBRATO;else if(5==(15&E))f.effect[u][c]=Effects.TONE_PORTA_VOL_SLIDE;else if(6==(15&E))f.effect[u][c]=Effects.VIBRATO_VOL_SLIDE;else if(7==(15&E))f.effect[u][c]=Effects.TREMOLO;else if(8==(15&E))f.effect[u][c]=Effects.SET_PAN;else if(9==(15&E))f.effect[u][c]=Effects.SAMPLE_OFFSET;else if(10==(15&E))f.effect[u][c]=Effects.VOLUME_SLIDE;else if(11==(15&E))f.effect[u][c]=Effects.POSITION_JUMP;else if(12==(15&E))f.effect[u][c]=Effects.SET_VOLUME;else if(13==(15&E))f.effect[u][c]=Effects.PATTERN_BREAK;else if(14==(15&E))switch((240&v)>>4){case 0:f.effect[u][c]=Effects.SET_FILTER;break;case 1:f.effect[u][c]=Effects.FINE_PORTA_UP;break;case 2:f.effect[u][c]=Effects.FINE_PORTA_DOWN;break;case 3:f.effect[u][c]=Effects.SET_GLISANDO;break;case 4:f.effect[u][c]=Effects.SET_VIBRATO;break;case 5:f.effect[u][c]=Effects.SET_FINETUNE;break;case 6:f.effect[u][c]=Effects.SET_LOOP;break;case 7:f.effect[u][c]=Effects.SET_TREMOLO;break;case 8:f.effect[u][c]=Effects.SET_PAN_16;break;case 9:f.effect[u][c]=Effects.RETRIGGER;break;case 10:f.effect[u][c]=Effects.FINE_VOL_SLIDE_UP;break;case 11:f.effect[u][c]=Effects.FINE_VOL_SLIDE_DOWN;break;case 12:f.effect[u][c]=Effects.CUT_NOTE;break;case 13:f.effect[u][c]=Effects.DELAY_NOTE;break;case 14:f.effect[u][c]=Effects.DELAY_PATTERN;break;default:f.effect[u][c]=Effects.NONE}else f.effect[u][c]=15==(15&E)?Effects.SET_TEMPO_BPM:Effects.NONE}t.patterns.push(f)}for(var M=l*i+1084,n=0;n<t.instruments.length;n++)t.instruments[n].samples[0].loadSample(e.subarray(M,M+t.instruments[n].samples[0].sampleLength),!1,t.signedSample),t.instruments[n].samples[0].sample[0]=0,t.instruments[n].samples[0].sample[1]=0,M+=t.instruments[n].samples[0].sampleLength;return t},ModuleLoaders.loadS3M=function(e){var t=new Module;t.type=Module.Types.S3M,t.channels=32,t.name=ModuleLoaders.readString(e,0,28),t.songLength=ModuleLoaders.readWord(e,32),t.sampleCount=ModuleLoaders.readWord(e,34),t.patternCount=ModuleLoaders.readWord(e,36),t.signedSample=1===e[42]?!0:!1,t.volumeSlideFlag=0!==(64&e[38])||0===e[40],t.defaultVolume=e[48]/64,t.defaultTempo=0===e[49]?6:e[49],t.defaultBPM=e[50]<33?125:e[50],t.defaultVolume=e[51]/64;for(var a=0;a<t.songLength;a++)t.orders[a]=e[96+a];for(var n=96+t.songLength,o=96+t.songLength+2*t.sampleCount,a=0;a<t.sampleCount;a++){var s=new Module.Instrument,r=16*ModuleLoaders.readWord(e,n+2*a),l=e.subarray(r,r+80),i=new Module.Sample;i.sampleIndex=a,i.name=ModuleLoaders.readString(l,48,28),i.sampleLength=ModuleLoaders.readWord(l,16),i.loopStart=ModuleLoaders.readWord(l,20),i.loopLength=ModuleLoaders.readWord(l,24),-i.loopStart,i.volume=l[28]/64,i.loopType=0!==(1&l[31])?Module.Sample.SampleLoop.LOOP_FORWARD:Module.Sample.SampleLoop.LOOP_NONE,i.basePeriod=ModuleLoaders.readWord(l,32),i.basePeriod=i.basePeriod/8363,i.basePeriod=Math.log(i.basePeriod)/Math.log(2)*768+3168,i.basePeriod=-(Math.floor(i.basePeriod/64)-72);var p=16*l[14]+4096*l[15],f=0!==(4&l[31]),u=i.sampleLength*(f?2:1);0===(2&l[31])?i.loadSample(e.subarray(p,p+u),f,t.signedSample):i.loadStereoSample(e.subarray(p,p+u),f,t.signedSample),s.name=i.name,s.samples.push(i),t.instruments.push(s)}for(var c=0;c<t.patternCount;c++){for(var m=16*ModuleLoaders.readWord(e,o+2*c),d=ModuleLoaders.readWord(e,m),h=e.subarray(m,m+d),E=new Module.Pattern(64,t.channels),v=2,a=0;64!==a&&h.length-v>0;){var T=h[v];if(0!==T){var S=31&T;if(0!==(32&T)){if(v++,254===h[v])E.note[a][S]=97;else if(255===h[v])E.note[a][S]=0;else{var M=12*Math.floor(h[v]/16);E.note[a][S]=h[v]%16+M+1}E.instrument[a][S]=h[++v]}if(E.volume[a][S]=0!==(64&T)?h[++v]:-1,0!==(128&T)){var O=h[++v],P=h[++v];switch(E.effectParam[a][S]=P,O){case 1:E.effect[a][S]=Effects.SET_SPEED;break;case 2:E.effect[a][S]=Effects.POSITION_JUMP;break;case 3:E.effect[a][S]=Effects.PATTERN_BREAK;break;case 4:E.effect[a][S]=Effects.VOLUME_SLIDE;break;case 5:E.effect[a][S]=Effects.PORTA_DOWN,P>=240?E.effectParam[a][S]=Math.round(P%16/16):P>=224&&(E.effectParam[a][S]=Math.round(P%16/4));break;case 6:E.effect[a][S]=Effects.PORTA_UP,P>=240?E.effectParam[a][S]=Math.round(P%16/16):P>=224&&(E.effectParam[a][S]=Math.round(P%16/4));break;case 7:E.effect[a][S]=Effects.TONE_PORTA;break;case 8:E.effect[a][S]=Effects.VIBRATO;break;case 9:E.effect[a][S]=Effects.TREMOR;break;case 10:E.effect[a][S]=Effects.ARPEGGIO;break;case 11:E.effect[a][S]=Effects.VIBRATO_VOL_SLIDE;break;case 12:E.effect[a][S]=Effects.TONE_PORTA_VOL_SLIDE;break;case 15:E.effect[a][S]=Effects.SAMPLE_OFFSET;break;case 17:E.effect[a][S]=Effects.RETRIG_VOL_SLIDE;break;case 18:E.effect[a][S]=Effects.TREMOLO;break;case 19:var L=(240&P)>>4;switch(L){case 0:E.effect[a][S]=Effects.SET_FILTER;break;case 1:E.effect[a][S]=Effects.SET_GLISANDO;break;case 2:E.effect[a][S]=Effects.SET_FINETUNE;break;case 3:E.effect[a][S]=Effects.SET_VIBRATO;break;case 4:E.effect[a][S]=Effects.SET_TREMOLO;break;case 8:case 10:E.effect[a][S]=Effects.SET_PAN_16;break;case 11:E.effect[a][S]=Effects.SET_LOOP;break;case 12:E.effect[a][S]=Effects.CUT_NOTE;break;case 13:E.effect[a][S]=Effects.DELAY_NOTE;break;case 14:E.effect[a][S]=Effects.DELAY_PATTERN;break;default:console.log("Unknown effect: "+O+", "+P),E.effect[a][S]=Effects.NONE}break;case 20:E.effect[a][S]=Effects.SET_TEMPO;break;case 21:break;case 22:E.effect[a][S]=Effects.SET_GLOBAL_VOLUME;break;default:console.log("Unknown effect: "+O+", "+P),E.effect[a][S]=Effects.NONE}}}else a++;v++}t.patterns.push(E)}return t},ModuleLoaders.loadXM=function(e){function t(e,t){switch(e){case 0:return Effects.ARPEGGIO;case 1:return Effects.PORTA_UP;case 2:return Effects.PORTA_DOWN;case 3:return Effects.TONE_PORTA;case 4:return Effects.VIBRATO;case 5:return Effects.TONE_PORTA_VOL_SLIDE;case 6:return Effects.VIBRATO_VOL_SLIDE;case 7:return Effects.TREMOLO;case 8:return Effects.SET_PAN;case 9:return Effects.SAMPLE_OFFSET;case 10:return Effects.VOLUME_SLIDE;case 11:return Effects.POSITION_JUMP;case 12:return Effects.SET_VOLUME;case 13:return Effects.PATTERN_BREAK;case 14:var a=(240&t)>>4;switch(a){case 1:return Effects.FINE_PORTA_UP;case 2:return Effects.FINE_PORTA_DOWN;case 3:return Effects.SET_GLISANDO;case 4:return Effects.SET_VIBRATO;case 5:return Effects.SET_FINETUNE;
case 6:return Effects.SET_LOOP;case 7:return Effects.SET_TREMOLO;case 9:return Effects.RETRIGGER;case 10:return Effects.FINE_VOL_SLIDE_UP;case 11:return Effects.FINE_VOL_SLIDE_DOWN;case 12:return Effects.CUT_NOTE;case 13:return Effects.DELAY_NOTE;case 14:return Effects.DELAY_PATTERN;default:return Effects.NONE}case 15:return Effects.SET_TEMPO_BPM;case 16:return Effects.SET_GLOBAL_VOLUME;case 17:return Effects.GLOBAL_VOLUME_SLIDE;case 21:return Effects.ENVELOPE_POSITION;case 25:return Effects.PAN_SLIDE;case 27:return Effects.RETRIG_VOL_SLIDE;case 29:return Effects.TREMOR;case 33:var a=(240&t)>>4;switch(a){case 1:return Effects.EXTRA_FINE_PORTA_UP;case 2:return Effects.EXTRA_FINE_PORTA_DOWN;default:return Effects.NONE}default:return Effects.NONE}}var a=new Module;a.type=Module.Types.XM;var n=ModuleLoaders.readDWord(e,60),o=0;a.name=ModuleLoaders.readString(e,17,20),a.songLength=ModuleLoaders.readWord(e,64),a.restartPosition=ModuleLoaders.readWord(e,66),a.channels=Math.min(ModuleLoaders.readWord(e,68),32),a.patternCount=ModuleLoaders.readWord(e,70),a.instrumentCount=ModuleLoaders.readWord(e,72),a.defaultTempo=ModuleLoaders.readWord(e,76),a.defaultBPM=ModuleLoaders.readWord(e,78);for(var s=0;s<a.songLength;s++)a.orders.push(e[80+s]);o+=n+60;for(var r=0;r<a.patternCount;r++){var l=ModuleLoaders.readDWord(e,o),i=ModuleLoaders.readWord(e,o+5),p=ModuleLoaders.readWord(e,o+7),f=new Module.Pattern(i,a.channels);if(f.patternIndex=r,0!=p)for(var u=o+l,c=0;i>c;c++)for(var m=0;m<a.channels;m++){var d=e[u++];if(0==(128&d)){f.note[c][m]=d,f.instrument[c][m]=e[u++];var h=Math.max(-1,e[u++]-16);f.volume[c][m]=h,f.effect[c][m]=e[u++],f.effectParam[c][m]=e[u++]}else{if(0!=(1&d)&&(f.note[c][m]=e[u++]),0!=(2&d)&&(f.instrument[c][m]=e[u++]),0!=(4&d)){var h=Math.max(-1,e[u++]-16);f.volume[c][m]=h}else f.volume[c][m]=-1;0!=(8&d)&&(f.effect[c][m]=e[u++]),0!=(16&d)&&(f.effectParam[c][m]=e[u++]),0==(8&d)&&0!=(16&d)&&(f.effect[c][m]=0)}f.effect[c][m]!=Effects.NONE&&(f.effect[c][m]=t(f.effect[c][m],f.effectParam[c][m]))}a.patterns.push(f),o+=l+p}for(var s=0;s<a.instrumentCount;s++){var E=new Module.Instrument,v=ModuleLoaders.readDWord(e,o);if(E.name=ModuleLoaders.readString(e,o+4,22),E.type=e[o+26],E.numSamples=ModuleLoaders.readWord(e,o+27),0==E.numSamples)o+=v;else{for(var T=0;96>T;T++)E.sampleKeyMap[T]=e[o+33+T];var S=new Module.Envelope;S.type=e[o+233];var M=e[o+225],O=e[o+227],P=e[o+228],L=e[o+229],g=new Module.Envelope;g.type=e[o+234];for(var _=e[o+226],R=e[o+230],N=e[o+231],b=e[o+232],A=0;12>A;A++)M>A&&S.addPoint(ModuleLoaders.readWord(e,o+129+4*A),Math.min(ModuleLoaders.readWord(e,o+131+4*A)/64,1),A==O,A==P,A==L),_>A&&g.addPoint(ModuleLoaders.readWord(e,o+177+4*A),Math.min(ModuleLoaders.readWord(e,o+179+4*A)/64,1),A==R,A==N,A==b);E.volumeEnvelope=S,E.panningEnvelope=g,o+=v;for(var k=0;k<E.numSamples;k++){var V=new Module.Sample;V.sampleLength=ModuleLoaders.readDWord(e,o),V.loopStart=ModuleLoaders.readDWord(e,o+4),V.loopLength=ModuleLoaders.readDWord(e,o+8),V.volume=e[o+12]/64,V.fineTune=e[o+13]<128?e[o+13]:-((255^e[o+13])+1),V.loopType=V.loopLength>0?3&e[o+14]:Module.Sample.SampleLoop.LOOP_NONE,V.dataType=0==(16&e[o+14])?Module.Sample.SampleFormat.FORMAT_8BIT:Module.Sample.SampleFormat.FORMAT_16BIT,V.panning=e[o+15]/255,V.basePeriod=e[o+16],V.dataType|=173==e[o+17]?Module.Sample.SampleFormat.TYPE_ADPCM:Module.Sample.SampleFormat.TYPE_DELTA,V.name=E.name,V.basePeriod>127&&(V.basePeriod=-(256-V.basePeriod)),V.basePeriod=-V.basePeriod+24,E.samples.push(V),o+=40}for(var k=0;k<E.numSamples;k++){var V=E.samples[k];if(V.sampleLength>0){var I=e.subarray(o,o+V.sampleLength),D=0!=(V.dataType&Module.Sample.SampleFormat.FORMAT_16BIT);0==(V.dataType&Module.Sample.SampleFormat.TYPE_DELTA)?V.loadDeltaSample(I,D):V.loadAdpcmSample(I,D),o+=V.sampleLength,0!=(V.dataType&Module.Sample.SampleFormat.FORMAT_16BIT)&&(V.sampleLength/=2,V.loopStart/=2,V.loopLength/=2)}}}a.instruments.push(E)}return a};var ChannelRegisters=function(){this.instrument=0,this.sample={sample:null,position:0,step:0,remain:0,reversed:!1},this.volume={channelVolume:0,sampleVolume:0,volumeSlide:0,envelope:null},this.panning={pan:.5,panSlide:0,envelope:null},this.porta={notePeriod:0,step:0},this.vibrato={position:0,step:0,amplitude:0},this.tremolo={position:0,step:0,amplitude:0,volume:1},this.tremor={onCount:0,offCount:0,muted:!1},this.isMuted=!1,this.note=0,this.period=0,this.noteDelay=0,this.loopMark=0,this.loopCount=0,this.tremorCount=0,this.envelopePos=0,this.noteReleased=!1,this.reset=function(){this.sample.sample=null,this.sample.position=0,this.sample.step=0,this.sample.remain=0,this.sample.reversed=!1,this.volume.channelVolume=0,this.volume.sampleVolume=0,this.volume.volumeSlide=0,this.volume.envelope=null,this.panning.pan=.5,this.panning.panSlide=0,this.panning.envelope=null,this.porta.notePeriod=0,this.porta.step=0,this.vibrato.position=0,this.vibrato.step=0,this.vibrato.amplitude=0,this.tremolo.position=0,this.tremolo.step=0,this.tremolo.amplitude=0,this.tremolo.volume=1,this.tremor.onCount=0,this.tremor.offCount=0,this.tremor.muted=!1,this.isMuted=!1,this.tremorMute=!1,this.note=0,this.period=0,this.noteDelay=0,this.loopMark=0,this.loopCount=0,this.envelopePos=0,this.noteReleased=!1}};ScripTracker.Events={playerReady:"SONG_LOADED",play:"PLAY",stop:"STOP",songEnded:"SONG_END",row:"NEW_ROW",order:"NEW_ORDER",instrument:"INSTRUMENT",effect:"EFFECT"};